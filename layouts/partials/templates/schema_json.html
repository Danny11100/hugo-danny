{{- $publisherType := (site.Params.schema.publisherType | default "Organization") | title -}}
{{- $logo := site.Params.assets.favicon | default "favicon.ico" | absURL -}}
{{- $siteDescription := site.Params.description | plainify | trim " \n\t" -}}

{{- if .IsHome -}}
  {{- $org := dict
    "@context" "https://schema.org"
    "@type" $publisherType
    "name" site.Title
    "url" site.Home.Permalink
    "description" $siteDescription
    "logo" (dict "@type" "ImageObject" "url" $logo)
  -}}
  {{- $sameAs := slice -}}
  {{- with site.Params.schema.sameAs -}}
    {{- $sameAs = . -}}
  {{- end -}}
  {{- with site.Params.socialIcons -}}
    {{- range . -}}
      {{- with .url -}}
        {{- $sameAs = $sameAs | append (trim . " ") -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- if gt (len $sameAs) 0 -}}
    {{- $org = merge $org (dict "sameAs" $sameAs) -}}
  {{- end -}}
<script type="application/ld+json">{{ $org | jsonify | safeHTML }}</script>
{{- else if (or .IsPage .IsSection) -}}
  {{- $breadcrumbs := slice -}}
  {{- $pos := 1 -}}
  {{- $breadcrumbs = $breadcrumbs | append (dict "@type" "ListItem" "position" $pos "name" site.Title "item" site.Home.Permalink) -}}
  {{- $pos = add $pos 1 -}}
  {{- range .Ancestors.Reverse -}}
    {{- if not .IsHome -}}
      {{- $breadcrumbs = $breadcrumbs | append (dict "@type" "ListItem" "position" $pos "name" .Title "item" .Permalink) -}}
      {{- $pos = add $pos 1 -}}
    {{- end -}}
  {{- end -}}
  {{- if not .IsHome -}}
    {{- $breadcrumbs = $breadcrumbs | append (dict "@type" "ListItem" "position" $pos "name" .Title "item" .Permalink) -}}
  {{- end -}}
  {{- $breadcrumbData := dict "@context" "https://schema.org" "@type" "BreadcrumbList" "itemListElement" $breadcrumbs -}}
<script type="application/ld+json">{{ $breadcrumbData | jsonify | safeHTML }}</script>

  {{- if .IsPage -}}
    {{- $title := .Title | plainify -}}
    {{- $description := .Description | default .Summary -}}
    {{- $description = $description | plainify | htmlUnescape | trim " \n\t" -}}
    {{- if gt (len $description) 200 -}}
      {{- $description = $description | truncate 200 -}}
    {{- end -}}

    {{- $keywords := slice -}}
    {{- with .Params.keywords -}}
      {{- $keywords = . -}}
    {{- else -}}
      {{- if .Params.tags -}}
        {{- $keywords = .Params.tags -}}
      {{- end -}}
    {{- end -}}

    {{- $authorValue := .Params.author | default site.Params.author -}}
    {{- $authors := slice -}}
    {{- with $authorValue -}}
      {{- $authorType := (printf "%T" .) -}}
      {{- if or (eq $authorType "[]string") (eq $authorType "[]interface {}") -}}
        {{- range . -}}
          {{- $authors = $authors | append (dict "@type" "Person" "name" .) -}}
        {{- end -}}
      {{- else -}}
        {{- if reflect.IsMap . -}}
          {{- with .name -}}
            {{- $authors = $authors | append (dict "@type" "Person" "name" .) -}}
          {{- end -}}
        {{- else -}}
          {{- $authors = $authors | append (dict "@type" "Person" "name" .) -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- $image := "" -}}
    {{- if .Params.cover.image -}}
      {{- if (ne .Params.cover.relative true) -}}
        {{- $image = .Params.cover.image | absURL -}}
      {{- else -}}
        {{- $image = (path.Join .RelPermalink .Params.cover.image) | absURL -}}
      {{- end -}}
    {{- else -}}
      {{- if .Params.images -}}
        {{- $image = (index .Params.images 0) | absURL -}}
      {{- else -}}
        {{- if site.Params.images -}}
          {{- $image = (index site.Params.images 0) | absURL -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- $iso8601 := "2006-01-02T15:04:05-07:00" -}}
    {{- $published := "" -}}
    {{- with .PublishDate -}}
      {{- $published = .Format $iso8601 -}}
    {{- end -}}
    {{- $modified := "" -}}
    {{- with .Lastmod -}}
      {{- $modified = .Format $iso8601 -}}
    {{- end -}}

    {{- $blog := dict
      "@context" "https://schema.org"
      "@type" "BlogPosting"
      "headline" $title
      "name" $title
      "description" $description
      "inLanguage" (.Site.Language.Lang | default "en")
      "wordCount" .WordCount
      "mainEntityOfPage" (dict "@type" "WebPage" "@id" .Permalink)
      "publisher" (dict "@type" $publisherType "name" site.Title "logo" (dict "@type" "ImageObject" "url" $logo))
    -}}
    {{- if $image -}}
      {{- $blog = merge $blog (dict "image" (slice $image)) -}}
    {{- end -}}
    {{- if gt (len $keywords) 0 -}}
      {{- $blog = merge $blog (dict "keywords" $keywords) -}}
    {{- end -}}
    {{- if $published -}}
      {{- $blog = merge $blog (dict "datePublished" $published) -}}
    {{- end -}}
    {{- if $modified -}}
      {{- $blog = merge $blog (dict "dateModified" $modified) -}}
    {{- end -}}
    {{- if .Section -}}
      {{- $blog = merge $blog (dict "articleSection" .Section) -}}
    {{- end -}}
    {{- if gt (len $authors) 0 -}}
      {{- $blog = merge $blog (dict "author" (cond (eq (len $authors) 1) (index $authors 0) $authors)) -}}
    {{- end -}}
<script type="application/ld+json">{{ $blog | jsonify | safeHTML }}</script>
  {{- end -}}
{{- end -}}
