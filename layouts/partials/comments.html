{{- $g := site.Params.giscus -}}
{{- if and $g $g.repo $g.repoId -}}
<details class="comments" id="comments">
    <summary>View comments</summary>
    <div class="giscus" id="giscus-container"></div>
</details>
<noscript>
    <p>Comments require JavaScript.</p>
</noscript>
<script>
    (function () {
        const details = document.getElementById('comments');
        const container = document.getElementById('giscus-container');
        if (!details || !container) return;

        const config = {{- dict
            "repo" $g.repo
            "repoId" $g.repoId
            "category" ($g.category | default "")
            "categoryId" ($g.categoryId | default "")
            "mapping" ($g.mapping | default "pathname")
            "strict" ($g.strict | default "0")
            "reactionsEnabled" ($g.reactionsEnabled | default "1")
            "emitMetadata" ($g.emitMetadata | default "0")
            "inputPosition" ($g.inputPosition | default "bottom")
            "lang" (.Site.Language.Lang | default "en")
            "themeLight" ($g.theme.light | default "light")
            "themeDark" ($g.theme.dark | default "dark")
        | jsonify | safeJS }};

        const getTheme = () => {
            const stored = localStorage.getItem('pref-theme');
            if (stored === 'light') return config.themeLight;
            if (stored === 'dark') return config.themeDark;
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? config.themeDark : config.themeLight;
        };

        const loadGiscus = () => {
            if (container.dataset.loaded === 'true') return;
            const script = document.createElement('script');
            script.src = 'https://giscus.app/client.js';
            script.async = true;
            script.crossOrigin = 'anonymous';
            script.setAttribute('data-repo', config.repo);
            script.setAttribute('data-repo-id', config.repoId);
            if (config.category) script.setAttribute('data-category', config.category);
            if (config.categoryId) script.setAttribute('data-category-id', config.categoryId);
            script.setAttribute('data-mapping', config.mapping);
            script.setAttribute('data-strict', config.strict);
            script.setAttribute('data-reactions-enabled', config.reactionsEnabled);
            script.setAttribute('data-emit-metadata', config.emitMetadata);
            script.setAttribute('data-input-position', config.inputPosition);
            script.setAttribute('data-theme', getTheme());
            script.setAttribute('data-lang', config.lang);
            container.appendChild(script);
            container.dataset.loaded = 'true';
        };

        const syncTheme = () => {
            const iframe = document.querySelector('iframe.giscus-frame');
            if (!iframe) return;
            iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: getTheme() } } }, 'https://giscus.app');
        };

        details.addEventListener('toggle', () => {
            if (details.open) loadGiscus();
        });

        const toggle = document.getElementById('theme-toggle');
        if (toggle) {
            toggle.addEventListener('click', () => {
                setTimeout(syncTheme, 50);
            });
        }
    })();
</script>
{{- end -}}
